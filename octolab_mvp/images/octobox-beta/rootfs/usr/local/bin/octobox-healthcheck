#!/bin/sh
set -eu

PORT="${VNC_RFBPORT:-5900}"
DEBUG_FLAG="${OCTOLAB_HEALTH_DEBUG:-0}"

log_debug() {
    if [ "$DEBUG_FLAG" = "1" ]; then
        printf '[octobox-healthcheck] %s\n' "$1" >&2
    fi
}

check_port() {
    if command -v nc >/dev/null 2>&1; then
        if nc -z -w 1 127.0.0.1 "$PORT" >/dev/null 2>&1; then
            return 0
        fi
        # Try IPv6 loopback as a fallback (if bound there)
        if nc -z -w 1 ::1 "$PORT" >/dev/null 2>&1; then
            return 0
        fi
    fi

    if command -v python3 >/dev/null 2>&1; then
        python3 <<'PY'
import os
import socket
import sys

port = int(os.environ.get('VNC_RFBPORT', '5900'))
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.settimeout(0.5)
try:
    sock.connect(("127.0.0.1", port))
except OSError:
    sys.exit(1)
finally:
    sock.close()
PY
        return $?
    fi

    log_debug "Neither nc nor python3 connectivity checks succeeded"
    return 1
}

check_vnc_process() {
    if command -v pgrep >/dev/null 2>&1; then
        if ! pgrep -x Xtigervnc >/dev/null 2>&1; then
            log_debug "Xtigervnc process not found"
            return 1
        fi
    fi
    return 0
}

if ! check_port; then
    log_debug "Port ${PORT} is not accepting connections"
    exit 1
fi

if ! check_vnc_process; then
    log_debug "VNC process check failed"
    exit 1
fi

exit 0
