# Evidence Collection

This document describes what evidence is collected during lab sessions and how it is packaged for download.

## What is Captured

OctoLab collects two types of evidence during lab sessions:

1. **Command Logs**: Terminal I/O (commands and outputs) from the OctoBox (Kali) attacker VM, recorded by the `script` utility
2. **Network Logs**: Structured network traffic logs captured by the gateway container

## Evidence Location

All evidence is stored in a shared Docker volume (`lab_evidence`) that is mounted at `/evidence` in both:
- The OctoBox container (Kali attacker VM)
- The gateway container (network capture)

### Files in `/evidence`

- `commands.log`: Terminal I/O transcript in PTY format (full terminal session recording)
  - Format: Standard `script` output format, containing both user input (commands) and command output
  - Suitable for replay with `scriptreplay` using the corresponding `commands.time` file
  - Captures all terminal activity including prompts, commands, and their outputs
  
- `commands.time`: Timing data for terminal replay (binary format)
  - Format: Binary timing file generated by `script -t`
  - Used with `scriptreplay` to replay terminal sessions with accurate timing
  - Required for proper replay of `commands.log`
  
- `network.json`: Structured network logs in JSON format (JSON Lines - one object per line)
  - Format: TShark JSON output (either Elastic-style `-T ek` or Wireshark `-T json`)
  - Contains: timestamp, source/destination IPs and ports, protocol, packet length, and other flow metadata
  
- `metadata.json`: Lab metadata (generated at evidence download time)
  - Contains: `lab_id`, `generated_at` (ISO8601), `evidence_version` (currently "2.0"),
    `commands_log_format` ("script-tty"), `commands_log_path`, `commands_log_sha256`,
    `commands_timing_path`, `commands_timing_sha256`

## Evidence Download

Evidence is downloaded as a single `.tar.gz` file via `GET /labs/{lab_id}/evidence`.

The tarball contains:
- `commands.log` - Terminal I/O transcript from OctoBox (script PTY format)
- `commands.time` - Timing data for replay
- `network.json` - Network traffic logs from gateway
- `metadata.json` - Lab metadata including SHA256 checksums for `commands.log` and `commands.time`

**Note**: Raw PCAP files are no longer included in the exported evidence bundle. PCAPs may still exist internally for debugging purposes but are not part of the user-facing evidence download.

## Limitations

### Command Logging
- **Terminal I/O recording**: All terminal input (commands) and output (results) are captured via the `script` utility, which wraps the user's shell.
- **PTY format**: Commands are logged in standard `script` format, which is suitable for replay with `scriptreplay` but requires parsing for structured analysis.
- **Login shell wrapper**: The `octolog-shell` wrapper is set as the user's login shell, ensuring all terminal sessions (including XFCE Terminal via noVNC) are recorded.
- **Not tamper-proof**: Users can disable logging by setting `OCTOLOG_DISABLE=1` or modifying the wrapper. This is an MVP limitation; tamper-proof logging will be implemented in a future update.

### Network Logging
- **LAN interface only**: Network logs capture traffic on the lab network (`lab_net`), not egress traffic to external networks.
- **Basic flow information**: TShark JSON format captures basic packet/flow metadata. Protocol-specific details may be limited compared to full packet analysis.
- **Performance**: High traffic volumes may cause some packet loss or performance impact on the gateway container.

## Evidence Retention

Evidence is retained for **24 hours** after lab termination. After the retention period expires:
- The evidence download endpoint returns 404
- A background cleanup job removes the underlying Docker volume
- Evidence cannot be recovered after deletion

## Technical Details

### Command Logging Implementation
- Wrapper: `/usr/local/bin/octolog-shell` (installed in OctoBox Dockerfile)
- Mechanism: `script` utility wraps `/bin/bash` and logs all terminal I/O to PTY format
- Log files: `/evidence/commands.log` (transcript) and `/evidence/commands.time` (timing data)
- Tool: `script` (from util-linux package) with flags:
  - `-q`: Quiet mode (no "Script started/done" messages)
  - `-f`: Flush output after each write
  - `-t`: Write timing data to `commands.time`
- The wrapper is set as the user's login shell, ensuring all terminal sessions are automatically recorded

### Network Logging Implementation
- Tool: TShark (from Wireshark package)
- Format: JSON (Elastic-style `-T ek` if available, otherwise `-T json`)
- Interface: Lab network interface (detected automatically)
- Log file: `/evidence/network.json` (shared volume)
- Buffering: Line-buffered (`-l` flag) for real-time logging

### Evidence Bundling
- Backend service: `backend/app/services/evidence_service.py`
- Process: Mounts `lab_evidence` volume into temporary Alpine container
- Computes SHA256 checksums for `commands.log` and `commands.time`
- Creates `metadata.json` with lab information and checksums
- Packages all files into `.tar.gz` archive
- Returns as streaming response for download

### Evidence Integrity Verification

To verify the integrity of downloaded evidence:

1. Extract the tarball:
   ```bash
   tar -xzf lab_{lab_id}_evidence.tar.gz
   ```

2. Check SHA256 checksums match metadata:
   ```bash
   sha256sum commands.log
   sha256sum commands.time
   ```
   
   Compare the output with the values in `metadata.json`:
   - `metadata.json["commands_log_sha256"]` should match `sha256sum commands.log`
   - `metadata.json["commands_timing_sha256"]` should match `sha256sum commands.time`

3. Replay terminal session (optional):
   ```bash
   scriptreplay commands.time commands.log
   ```
