---
# ENDING Labs Watchdog CronJob
#
# This CronJob runs the force_teardown_ending_labs.py script periodically to detect
# and process labs stuck in ENDING status for too long.
#
# Schedule: Every 10 minutes (configurable via spec.schedule)
# Safety: Uses skip_locked row-level locking to prevent conflicts with concurrent runs
#
# Prerequisites:
# - Backend image must be available in the cluster
# - Database access must be configured via environment variables or ConfigMap/Secret
# - Service account must have necessary permissions (if RBAC is enabled)
#
# Configuration:
# - Adjust DATABASE_URL to match your database connection
# - Adjust image to match your backend image name
# - Adjust SECRET_KEY for JWT (if needed by the app initialization)
# - Adjust schedule as needed (default: every 10 minutes)
#
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ending-watchdog
  namespace: octolab-system
  labels:
    app: ending-watchdog
    component: maintenance
spec:
  # Schedule: every 10 minutes (adjust as needed)
  # Format: "minute hour day-of-month month day-of-week"
  schedule: "*/10 * * * *"

  # Concurrency policy: Forbid means don't start new job if previous one is still running
  # This prevents multiple watchdog instances from running simultaneously
  concurrencyPolicy: Forbid

  # Number of successful job history to retain (for debugging)
  successfulJobsHistoryLimit: 3

  # Number of failed job history to retain (for debugging)
  failedJobsHistoryLimit: 5

  jobTemplate:
    spec:
      # Don't retry failed jobs automatically (the next CronJob run will handle it)
      backoffLimit: 0

      # Clean up completed jobs after 1 hour
      ttlSecondsAfterFinished: 3600

      template:
        metadata:
          labels:
            app: ending-watchdog
            component: maintenance
        spec:
          # Don't restart the pod if it fails (let the next CronJob run handle it)
          restartPolicy: Never

          # Security context for the pod
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000

          containers:
            - name: watchdog
              # CUSTOMIZE: Replace with your actual backend image
              # Example: myregistry.io/octolab-backend:v1.0.0
              image: octolab-backend:latest
              imagePullPolicy: IfNotPresent

              # Command to run the watchdog script
              command:
                - python
                - -m
                - app.scripts.force_teardown_ending_labs
              args:
                - --older-than-minutes=30
                - --max-labs=20
                - --action=force

              # Environment variables
              env:
                # Database connection (REQUIRED)
                # CUSTOMIZE: Use a Secret or ConfigMap for the database URL
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: octolab-backend-secrets
                      key: database_url

                # JWT secret key (may be required by app initialization)
                # CUSTOMIZE: Use a Secret for the secret key
                - name: SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: octolab-backend-secrets
                      key: secret_key

                # Optional: Set log level
                - name: LOG_LEVEL
                  value: "INFO"

                # Optional: Runtime type (k8s or compose)
                - name: OCTOLAB_RUNTIME
                  value: "k8s"

              # Resource limits to prevent runaway jobs
              resources:
                requests:
                  cpu: "100m"
                  memory: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "512Mi"

              # Security context for the container
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                runAsUser: 1000

              # Volume mounts (if needed)
              # Example: mount /tmp for Python temporary files
              volumeMounts:
                - name: tmp
                  mountPath: /tmp

          # Volumes
          volumes:
            - name: tmp
              emptyDir: {}

---
# Example Secret for database credentials
# CUSTOMIZE: Replace with your actual database credentials
# You can also use an external secret management system (e.g., Sealed Secrets, External Secrets Operator)
apiVersion: v1
kind: Secret
metadata:
  name: octolab-backend-secrets
  namespace: octolab-system
type: Opaque
stringData:
  # CUSTOMIZE: Replace with your actual database URL
  database_url: "postgresql+asyncpg://octolab:octolab_password@postgres-service:5432/octolab"
  # CUSTOMIZE: Replace with your actual JWT secret key
  secret_key: "change-me-to-a-secure-random-secret"
